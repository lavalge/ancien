<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OK Cuisine ‚Äî Scenarios de demonstration</title>
<style>
    body { font-family: 'Segoe UI', sans-serif; background: #0f0f1a; color: #e8e8e8; padding: 2rem; }
    h1 { color: #00b4d8; }
    h2 { color: #00b4d8; font-size: 1.3rem; margin-top: 1.5rem; }
    .btn { padding: 1rem 2rem; font-size: 1.2rem; border: none; border-radius: 12px; cursor: pointer; margin: 0.5rem; font-weight: 600; }
    .btn-scenario { background: #9b59b6; color: #fff; padding: 0.8rem 1.5rem; font-size: 1rem; min-width: 280px; text-align: left; }
    .btn-scenario:hover { background: #8e44ad; }
    .btn-clear { background: #e74c3c; color: #fff; }
    .btn-clear:hover { background: #c0392b; }
    .btn-back { background: #3498db; color: #fff; }
    .btn-back:hover { background: #2980b9; }
    .scenario-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .scenario-category { background: #1a1a2e; border: 1px solid #2a2a4a; border-radius: 12px; padding: 1.5rem; }
    .scenario-category h3 { color: #00b4d8; margin-top: 0; font-size: 1.1rem; }
    .scenario-description { font-size: 0.85rem; color: #888; margin: 0.3rem 0; }
    #log { background: #1a1a2e; border: 1px solid #2a2a4a; border-radius: 12px; padding: 1rem; margin-top: 1rem; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; line-height: 1.6; }
    .ok { color: #2ecc71; }
    .info { color: #00b4d8; }
    .warn { color: #f39c12; }
    .section { color: #a0a0b0; margin-top: 0.5rem; font-weight: bold; }
    p { color: #a0a0b0; margin: 0.5rem 0; }
</style>
</head>
<body>
<h1>OK Cuisine ‚Äî Scenarios de demonstration</h1>
<p>Choisissez un scenario de demonstration adapte a votre type d'etablissement.</p>
<p><strong>Aucun fichier de l'application n'est modifie.</strong> Seul le localStorage du navigateur est rempli.</p>
<hr style="border-color:#2a2a4a;margin:1rem 0;">

<h2>Scenarios disponibles</h2>

<div class="scenario-grid">
    <div class="scenario-category">
        <h3>üè´ Coll√®ge</h3>
        <button class="btn btn-scenario" onclick="injectScenario('college_standard')">
            üìä Coll√®ge Standard<br>
            <span class="scenario-description">400 √©l√®ves, fonctionnement normal (90 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('college_pic')">
            üö® Coll√®ge avec incidents<br>
            <span class="scenario-description">Alertes temp√©rature, non-conformit√©s (60 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('college_excellence')">
            ‚≠ê Coll√®ge Excellence<br>
            <span class="scenario-description">Contr√¥les renforc√©s, audits (120 jours)</span>
        </button>
    </div>

    <div class="scenario-category">
        <h3>üéì Lyc√©e</h3>
        <button class="btn btn-scenario" onclick="injectScenario('lycee_standard')">
            üìä Lyc√©e Standard<br>
            <span class="scenario-description">800 √©l√®ves, service self (90 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('lycee_professionnel')">
            üîß Lyc√©e Professionnel<br>
            <span class="scenario-description">Ateliers cuisine, formations (90 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('lycee_complexe')">
            üè¢ Lyc√©e Multi-sites<br>
            <span class="scenario-description">Production centralis√©e, livraisons (120 jours)</span>
        </button>
    </div>

    <div class="scenario-category">
        <h3>üé® √âcole Maternelle</h3>
        <button class="btn btn-scenario" onclick="injectScenario('maternelle_standard')">
            üìä Maternelle Standard<br>
            <span class="scenario-description">120 enfants, PAI allergies (90 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('maternelle_bio')">
            üå± Maternelle Bio<br>
            <span class="scenario-description">Circuits courts, produits bio (90 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('maternelle_petit')">
            üèòÔ∏è Petite Maternelle<br>
            <span class="scenario-description">60 enfants, gestion simplifi√©e (60 jours)</span>
        </button>
    </div>

    <div class="scenario-category">
        <h3>üë∂ Cr√®che</h3>
        <button class="btn btn-scenario" onclick="injectScenario('creche_standard')">
            üìä Cr√®che Standard<br>
            <span class="scenario-description">40 b√©b√©s, pur√©es, biberons (90 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('creche_micro')">
            üè† Micro-cr√®che<br>
            <span class="scenario-description">12 b√©b√©s, gestion familiale (60 jours)</span>
        </button>
        <button class="btn btn-scenario" onclick="injectScenario('creche_multi_accueil')">
            üé™ Multi-accueil<br>
            <span class="scenario-description">60 enfants 0-3 ans, diversifi√© (90 jours)</span>
        </button>
    </div>
</div>

<hr style="border-color:#2a2a4a;margin:1rem 0;">
<button class="btn btn-clear" onclick="clearData()">Vider toutes les donnees OK Cuisine</button>
<button class="btn btn-back" onclick="window.location.href='index.html'">Retour a l'application</button>
<div id="log"></div>

<script>
const P = 'okc_';
const logEl = document.getElementById('log');

function log(msg, cls = '') {
    logEl.innerHTML += `<div class="${cls}">${msg}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
}

function clearData() {
    const keys = [];
    for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k.startsWith(P)) keys.push(k);
    }
    keys.forEach(k => localStorage.removeItem(k));
    log(`${keys.length} cles supprimees.`, 'warn');
}

// ========== HELPERS ==========
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 6); }
function dateStr(d) { return d.toISOString().split('T')[0]; }
function isoAt(d, h, m) {
    const dt = new Date(d);
    dt.setHours(h, m, Math.floor(Math.random() * 60), 0);
    return dt.toISOString();
}
function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function randBetween(min, max) { return +(min + Math.random() * (max - min)).toFixed(1); }
function save(key, data) { localStorage.setItem(P + key, JSON.stringify(data)); }
function load(key) { try { return JSON.parse(localStorage.getItem(P + key)) || null; } catch(e) { return null; } }

// ========== DATA POOLS ==========
const USERS = [
    { id: 'chef_martin', nom: 'Chef Martin', initiales: 'CM', pin: '1234', role: 'admin' },
    { id: 'sophie_d', nom: 'Sophie Durand', initiales: 'SD', pin: '5678', role: 'employe' },
    { id: 'karim_b', nom: 'Karim Benali', initiales: 'KB', pin: '9012', role: 'employe' },
    { id: 'marie_l', nom: 'Marie Lefebvre', initiales: 'ML', pin: '3456', role: 'employe' }
];

const FOURNISSEURS = [
    { nom: 'Brake France', adresse: 'ZI des Platanes, 69400 Villefranche', telephone: '04 74 65 12 34', produits: 'Surgeles, epicerie, conserves', agrement: 'FR 69.123.001 CE' },
    { nom: 'Pomona TerreAzur', adresse: '15 rue du Marche, 13001 Marseille', telephone: '04 91 22 33 44', produits: 'Fruits, legumes frais', agrement: 'FR 13.456.002 CE' },
    { nom: 'Charal', adresse: 'Route de Cholet, 85000 La Roche-sur-Yon', telephone: '02 51 44 55 66', produits: 'Viandes bovines, steaks haches', agrement: 'FR 85.789.003 CE' },
    { nom: 'Davigel', adresse: '8 avenue de l\'Europe, 44000 Nantes', telephone: '02 40 11 22 33', produits: 'Surgeles, poissons, plats prepares', agrement: 'FR 44.012.004 CE' },
    { nom: 'Transgourmet', adresse: 'ZAC des Bords de Seine, 94500 Champigny', telephone: '01 48 82 33 44', produits: 'Epicerie, boissons, cremerie', agrement: 'FR 94.345.005 CE' },
    { nom: 'Boulangerie Dupain', adresse: '3 place de la Mairie, 69001 Lyon', telephone: '04 78 99 11 22', produits: 'Pain, viennoiseries', agrement: 'FR 69.567.006 CE' }
];

const ZONES_TEMP = [
    { id: 'frigo_legumes', nom: 'Frigo legumes', min: 0, max: 4 },
    { id: 'frigo_viandes', nom: 'Frigo viandes', min: 0, max: 3 },
    { id: 'frigo_produits_laitiers', nom: 'Frigo produits laitiers', min: 0, max: 4 },
    { id: 'frigo_poissons', nom: 'Frigo poissons', min: 0, max: 2 },
    { id: 'chambre_froide_positive', nom: 'Chambre froide positive', min: 0, max: 3 },
    { id: 'chambre_froide_negative', nom: 'Chambre froide negative', min: -25, max: -18 },
    { id: 'congelateur', nom: 'Congelateur', min: -25, max: -18 },
    { id: 'bain_marie', nom: 'Bain-marie / Maintien chaud', min: 63, max: 90 },
    { id: 'vitrine_froide', nom: 'Vitrine froide', min: 0, max: 4 }
];

const ZONES_NET = [
    'Plan de travail', 'Planches a decouper', 'Lavabo', 'Plonge', 'Surface / Tables',
    'Sol', 'Four', 'Friteuse', 'Hotte', 'Trancheuse', 'Chambre froide',
    'Refrigerateurs', 'Poignees / Interrupteurs', 'Vestiaire', 'Sanitaires',
    'Poubelles / Zone dechets', 'Materiel / Ustensiles'
];

const PRODUITS_NET = [
    'Degraissant', 'Desinfectant', 'Detergent', 'Eau de javel', 'Produit sol',
    'Nettoyant four', 'Degraissant hotte', 'Produit vaisselle', 'Desinfectant alimentaire',
    'Detergent-desinfectant'
];

const PRODUITS_RECEPTION = [
    { fournisseur: 'Brake France', produit: 'Steaks haches surgeles 100g', temp_attendue: -18 },
    { fournisseur: 'Brake France', produit: 'Frites surgelees 2.5kg', temp_attendue: -18 },
    { fournisseur: 'Brake France', produit: 'Nuggets de poulet surgeles', temp_attendue: -18 },
    { fournisseur: 'Pomona TerreAzur', produit: 'Carottes fraiches 5kg', temp_attendue: 4 },
    { fournisseur: 'Pomona TerreAzur', produit: 'Tomates grappe 3kg', temp_attendue: 8 },
    { fournisseur: 'Pomona TerreAzur', produit: 'Pommes Golden 5kg', temp_attendue: 8 },
    { fournisseur: 'Pomona TerreAzur', produit: 'Salade batavia x10', temp_attendue: 4 },
    { fournisseur: 'Pomona TerreAzur', produit: 'Courgettes fraiches 3kg', temp_attendue: 8 },
    { fournisseur: 'Charal', produit: 'Escalopes de poulet 2kg', temp_attendue: 2 },
    { fournisseur: 'Charal', produit: 'Roti de porc 3kg', temp_attendue: 3 },
    { fournisseur: 'Charal', produit: 'Filet de dinde 2.5kg', temp_attendue: 2 },
    { fournisseur: 'Davigel', produit: 'Filets de colin surgeles 2kg', temp_attendue: -18 },
    { fournisseur: 'Davigel', produit: 'Crevettes decortiquees 1kg', temp_attendue: -18 },
    { fournisseur: 'Transgourmet', produit: 'Yaourts nature x48', temp_attendue: 4 },
    { fournisseur: 'Transgourmet', produit: 'Beurre doux 1kg', temp_attendue: 4 },
    { fournisseur: 'Transgourmet', produit: 'Emmental rape 1kg', temp_attendue: 4 },
    { fournisseur: 'Transgourmet', produit: 'Compote pomme x48', temp_attendue: null },
    { fournisseur: 'Transgourmet', produit: 'Riz long grain 5kg', temp_attendue: null },
    { fournisseur: 'Transgourmet', produit: 'Huile tournesol 5L', temp_attendue: null },
    { fournisseur: 'Boulangerie Dupain', produit: 'Pain de campagne x20', temp_attendue: null },
    { fournisseur: 'Boulangerie Dupain', produit: 'Baguettes tradition x30', temp_attendue: null }
];

const INVENTAIRE_PRODUITS = [
    { nom: 'Steaks haches 100g', categorie: 'Surgeles', unite: 'carton(s)', qtyRange: [2, 8] },
    { nom: 'Frites surgelees', categorie: 'Surgeles', unite: 'sachet(s)', qtyRange: [5, 15] },
    { nom: 'Nuggets poulet', categorie: 'Surgeles', unite: 'sachet(s)', qtyRange: [3, 10] },
    { nom: 'Filets de colin', categorie: 'Surgeles', unite: 'sachet(s)', qtyRange: [2, 6] },
    { nom: 'Carottes', categorie: 'Legumes', unite: 'kg', qtyRange: [3, 15] },
    { nom: 'Tomates', categorie: 'Legumes', unite: 'kg', qtyRange: [2, 8] },
    { nom: 'Courgettes', categorie: 'Legumes', unite: 'kg', qtyRange: [2, 8] },
    { nom: 'Salade batavia', categorie: 'Legumes', unite: 'unite(s)', qtyRange: [5, 15] },
    { nom: 'Pommes Golden', categorie: 'Fruits', unite: 'kg', qtyRange: [3, 12] },
    { nom: 'Bananes', categorie: 'Fruits', unite: 'kg', qtyRange: [2, 8] },
    { nom: 'Escalopes de poulet', categorie: 'Viandes', unite: 'kg', qtyRange: [2, 6] },
    { nom: 'Roti de porc', categorie: 'Viandes', unite: 'kg', qtyRange: [1, 4] },
    { nom: 'Filet de dinde', categorie: 'Viandes', unite: 'kg', qtyRange: [1, 5] },
    { nom: 'Yaourts nature', categorie: 'Produits laitiers', unite: 'lot(s)', qtyRange: [2, 8] },
    { nom: 'Beurre doux', categorie: 'Produits laitiers', unite: 'kg', qtyRange: [1, 3] },
    { nom: 'Emmental rape', categorie: 'Produits laitiers', unite: 'sachet(s)', qtyRange: [2, 6] },
    { nom: 'Lait demi-ecreme', categorie: 'Produits laitiers', unite: 'L', qtyRange: [6, 20] },
    { nom: 'Creme fraiche', categorie: 'Produits laitiers', unite: 'L', qtyRange: [1, 4] },
    { nom: 'Riz long grain', categorie: 'Epicerie seche', unite: 'kg', qtyRange: [5, 20] },
    { nom: 'Pates penne', categorie: 'Epicerie seche', unite: 'kg', qtyRange: [5, 15] },
    { nom: 'Lentilles vertes', categorie: 'Epicerie seche', unite: 'kg', qtyRange: [2, 8] },
    { nom: 'Huile tournesol', categorie: 'Condiments', unite: 'L', qtyRange: [2, 10] },
    { nom: 'Vinaigre de vin', categorie: 'Condiments', unite: 'L', qtyRange: [1, 3] },
    { nom: 'Sel fin', categorie: 'Condiments', unite: 'kg', qtyRange: [1, 5] },
    { nom: 'Compote pomme', categorie: 'Conserves', unite: 'lot(s)', qtyRange: [2, 8] },
    { nom: 'Mais en boite', categorie: 'Conserves', unite: 'unite(s)', qtyRange: [5, 20] },
    { nom: 'Concentre de tomate', categorie: 'Conserves', unite: 'unite(s)', qtyRange: [3, 10] },
    { nom: 'Pain de campagne', categorie: 'Pain', unite: 'unite(s)', qtyRange: [5, 20] },
    { nom: 'Baguettes tradition', categorie: 'Pain', unite: 'unite(s)', qtyRange: [10, 30] },
    { nom: 'Liquide vaisselle', categorie: 'Produits d\'entretien', unite: 'L', qtyRange: [2, 6] },
    { nom: 'Degraissant cuisine', categorie: 'Produits d\'entretien', unite: 'L', qtyRange: [2, 5] },
    { nom: 'Essuie-tout', categorie: 'Consommables', unite: 'lot(s)', qtyRange: [2, 8] },
    { nom: 'Gants jetables M', categorie: 'Consommables', unite: 'carton(s)', qtyRange: [1, 4] },
    { nom: 'Film alimentaire', categorie: 'Consommables', unite: 'unite(s)', qtyRange: [1, 5] }
];

const CCP_PRODUITS = [
    { type: 'cuisson', produit: 'Poulet roti', temp_cible: 74, temp_range: [70, 82] },
    { type: 'cuisson', produit: 'Steak hache', temp_cible: 70, temp_range: [66, 78] },
    { type: 'cuisson', produit: 'Filet de colin', temp_cible: 63, temp_range: [60, 72] },
    { type: 'cuisson', produit: 'Roti de porc', temp_cible: 63, temp_range: [60, 72] },
    { type: 'cuisson', produit: 'Gratin dauphinois', temp_cible: 63, temp_range: [60, 70] },
    { type: 'cuisson', produit: 'Escalope de dinde', temp_cible: 74, temp_range: [70, 80] },
    { type: 'refroidissement', produit: 'Sauce bolognaise', temp_cible: 10, temp_range: [4, 15] },
    { type: 'refroidissement', produit: 'Puree de pommes de terre', temp_cible: 10, temp_range: [5, 14] },
    { type: 'refroidissement', produit: 'Ratatouille', temp_cible: 10, temp_range: [5, 13] },
    { type: 'remise_temp', produit: 'Hachis parmentier', temp_cible: 63, temp_range: [58, 72] },
    { type: 'remise_temp', produit: 'Blanquette de veau', temp_cible: 63, temp_range: [60, 70] }
];

const PLATS_ALLERGENES = [
    { nom: 'Poulet roti', categorie: 'Plat principal', allergenes: [], ingredients: 'Poulet, sel, poivre, herbes' },
    { nom: 'Steak hache frites', categorie: 'Plat principal', allergenes: ['gluten'], ingredients: 'Steak hache, frites, sel' },
    { nom: 'Filet de colin sauce citron', categorie: 'Plat principal', allergenes: ['poisson', 'lait'], ingredients: 'Colin, citron, beurre, creme' },
    { nom: 'Gratin dauphinois', categorie: 'Accompagnement', allergenes: ['lait'], ingredients: 'Pommes de terre, creme, lait, muscade' },
    { nom: 'Puree de carottes', categorie: 'Accompagnement', allergenes: ['lait'], ingredients: 'Carottes, beurre, sel' },
    { nom: 'Riz pilaf', categorie: 'Accompagnement', allergenes: [], ingredients: 'Riz, oignon, bouillon' },
    { nom: 'Pates bolognaise', categorie: 'Plat principal', allergenes: ['gluten', 'celeri'], ingredients: 'Pates, viande hachee, tomate, celeri' },
    { nom: 'Salade composee', categorie: 'Entree', allergenes: ['moutarde', 'sulfites'], ingredients: 'Salade, tomate, mais, vinaigrette' },
    { nom: 'Veloute de legumes', categorie: 'Entree', allergenes: ['lait', 'celeri'], ingredients: 'Legumes varies, creme, celeri' },
    { nom: 'Hachis parmentier', categorie: 'Plat principal', allergenes: ['lait'], ingredients: 'Viande hachee, puree, fromage' },
    { nom: 'Blanquette de veau', categorie: 'Plat principal', allergenes: ['lait', 'gluten'], ingredients: 'Veau, creme, farine, carottes' },
    { nom: 'Tarte aux pommes', categorie: 'Dessert', allergenes: ['gluten', 'lait', 'oeufs'], ingredients: 'Pate brisee, pommes, beurre, oeufs' },
    { nom: 'Creme dessert chocolat', categorie: 'Dessert', allergenes: ['lait', 'soja'], ingredients: 'Lait, chocolat, lecithine de soja' },
    { nom: 'Salade de fruits', categorie: 'Dessert', allergenes: [], ingredients: 'Fruits frais de saison' },
    { nom: 'Yaourt nature', categorie: 'Dessert', allergenes: ['lait'], ingredients: 'Lait, ferments lactiques' },
    { nom: 'Quiche lorraine', categorie: 'Plat principal', allergenes: ['gluten', 'lait', 'oeufs'], ingredients: 'Pate brisee, lardons, oeufs, creme' },
    { nom: 'Nuggets de poulet', categorie: 'Plat principal', allergenes: ['gluten'], ingredients: 'Poulet, chapelure, sel' },
    { nom: 'Compote de pommes', categorie: 'Dessert', allergenes: [], ingredients: 'Pommes, sucre' },
    { nom: 'Fromage blanc sucre', categorie: 'Dessert', allergenes: ['lait'], ingredients: 'Fromage blanc, sucre' },
    { nom: 'Saucisse de Toulouse lentilles', categorie: 'Plat principal', allergenes: ['sulfites'], ingredients: 'Saucisse, lentilles, oignon' }
];

const MENU_THEMES = [
    {
        theme_id: 'classique', theme_nom: 'Classique', collectivite_id: 'college', collectivite_nom: 'College',
        jours: [
            { jour: 'Lundi', entree: 'Salade de carottes rapees', plat: 'Poulet roti', accompagnement: 'Puree de pommes de terre', dessert: 'Compote de pommes', fromage: 'Emmental', allergenes: 'Lait' },
            { jour: 'Mardi', entree: 'Veloute de legumes', plat: 'Filet de colin sauce citron', accompagnement: 'Riz pilaf', dessert: 'Yaourt nature', fromage: 'Comte', allergenes: 'Poisson, Lait' },
            { jour: 'Mercredi', entree: 'Salade composee', plat: 'Steak hache', accompagnement: 'Frites', dessert: 'Fruit de saison', fromage: 'Camembert', allergenes: 'Gluten, Moutarde, Lait' },
            { jour: 'Jeudi', entree: 'Pate de campagne', plat: 'Blanquette de veau', accompagnement: 'Riz', dessert: 'Creme dessert chocolat', fromage: 'Brie', allergenes: 'Gluten, Lait, Soja' },
            { jour: 'Vendredi', entree: 'Concombre a la creme', plat: 'Quiche lorraine', accompagnement: 'Salade verte', dessert: 'Tarte aux pommes', fromage: 'Saint-Nectaire', allergenes: 'Gluten, Lait, Oeufs' }
        ]
    },
    {
        theme_id: 'classique', theme_nom: 'Classique', collectivite_id: 'college', collectivite_nom: 'College',
        jours: [
            { jour: 'Lundi', entree: 'Tomates vinaigrette', plat: 'Saucisse de Toulouse', accompagnement: 'Lentilles', dessert: 'Fromage blanc sucre', fromage: 'Cantal', allergenes: 'Lait, Sulfites' },
            { jour: 'Mardi', entree: 'Betteraves rapees', plat: 'Escalope de dinde panee', accompagnement: 'Puree de carottes', dessert: 'Salade de fruits', fromage: 'Emmental', allergenes: 'Gluten, Lait' },
            { jour: 'Mercredi', entree: 'Melon', plat: 'Pates bolognaise', accompagnement: 'Salade verte', dessert: 'Yaourt aux fruits', fromage: 'Tomme', allergenes: 'Gluten, Celeri, Lait' },
            { jour: 'Jeudi', entree: 'Soupe de legumes', plat: 'Hachis parmentier', accompagnement: 'Haricots verts', dessert: 'Compote pomme-poire', fromage: 'Brie', allergenes: 'Lait' },
            { jour: 'Vendredi', entree: 'Sardines a l\'huile', plat: 'Nuggets de poulet', accompagnement: 'Riz pilaf', dessert: 'Gateau au chocolat', fromage: 'Chevre', allergenes: 'Poisson, Gluten, Lait, Oeufs' }
        ]
    }
];

const ETIQ_PRODUITS = [
    { produit: 'Emmental rape', origine: 'France', temperature_stockage: '+3¬∞C' },
    { produit: 'Jambon blanc', origine: 'France', temperature_stockage: '+2¬∞C' },
    { produit: 'Salade verte', origine: 'France (Provence)', temperature_stockage: '+3¬∞C' },
    { produit: 'Creme fraiche', origine: 'France (Normandie)', temperature_stockage: '+3¬∞C' },
    { produit: 'Saumon fume', origine: 'Ecosse', temperature_stockage: '+2¬∞C' },
    { produit: 'Beurre doux', origine: 'France (Bretagne)', temperature_stockage: '+4¬∞C' },
    { produit: 'Poulet decoupe', origine: 'France (Vendee)', temperature_stockage: '+2¬∞C' }
];

const TEMOIN_PLATS = [
    'Poulet roti sauce jus', 'Steak hache au jus', 'Filet de colin meuniere',
    'Blanquette de veau', 'Hachis parmentier', 'Quiche lorraine',
    'Pates bolognaise', 'Saucisse lentilles', 'Nuggets frites'
];

// ========== SCENARIOS DEFINITIONS ==========
const SCENARIOS = {
    college_standard: {
        nom: 'Coll√®ge Standard',
        etablissement: 'Coll√®ge Victor Hugo',
        type: 'college',
        effectif: 400,
        jours: 90,
        description: '400 √©l√®ves, fonctionnement normal'
    },
    college_pic: {
        nom: 'Coll√®ge avec incidents',
        etablissement: 'Coll√®ge Jean Moulin',
        type: 'college',
        effectif: 450,
        jours: 60,
        description: 'Alertes temp√©rature, non-conformit√©s',
        incidents: true
    },
    college_excellence: {
        nom: 'Coll√®ge Excellence',
        etablissement: 'Coll√®ge Marie Curie',
        type: 'college',
        effectif: 380,
        jours: 120,
        description: 'Contr√¥les renforc√©s, audits',
        excellence: true
    },
    lycee_standard: {
        nom: 'Lyc√©e Standard',
        etablissement: 'Lyc√©e Jules Ferry',
        type: 'lycee',
        effectif: 800,
        jours: 90,
        description: '800 √©l√®ves, service self'
    },
    lycee_professionnel: {
        nom: 'Lyc√©e Professionnel',
        etablissement: 'Lyc√©e Professionnel Auguste Escoffier',
        type: 'lycee',
        effectif: 600,
        jours: 90,
        description: 'Ateliers cuisine, formations',
        professionnel: true
    },
    lycee_complexe: {
        nom: 'Lyc√©e Multi-sites',
        etablissement: 'Lyc√©e Henri IV - Site Central',
        type: 'lycee',
        effectif: 1200,
        jours: 120,
        description: 'Production centralis√©e, livraisons',
        multisites: true
    },
    maternelle_standard: {
        nom: 'Maternelle Standard',
        etablissement: '√âcole Maternelle Les Petits Loups',
        type: 'maternelle',
        effectif: 120,
        jours: 90,
        description: '120 enfants, PAI allergies',
        pai: true
    },
    maternelle_bio: {
        nom: 'Maternelle Bio',
        etablissement: '√âcole Maternelle Nature et D√©couvertes',
        type: 'maternelle',
        effectif: 100,
        jours: 90,
        description: 'Circuits courts, produits bio',
        bio: true
    },
    maternelle_petit: {
        nom: 'Petite Maternelle',
        etablissement: '√âcole Maternelle Petit Prince',
        type: 'maternelle',
        effectif: 60,
        jours: 60,
        description: 'Gestion simplifi√©e',
        petit: true
    },
    creche_standard: {
        nom: 'Cr√®che Standard',
        etablissement: 'Cr√®che Les Bambins',
        type: 'creche',
        effectif: 40,
        jours: 90,
        description: '40 b√©b√©s, pur√©es, biberons',
        bebes: true
    },
    creche_micro: {
        nom: 'Micro-cr√®che',
        etablissement: 'Micro-cr√®che Les C√¢lins',
        type: 'creche',
        effectif: 12,
        jours: 60,
        description: 'Gestion familiale',
        micro: true
    },
    creche_multi_accueil: {
        nom: 'Multi-accueil',
        etablissement: 'Multi-accueil Les Explorateurs',
        type: 'creche',
        effectif: 60,
        jours: 90,
        description: '60 enfants 0-3 ans',
        multiaccueil: true
    }
};


// ========== MAIN INJECTION ==========
function injectData() {
    logEl.innerHTML = '';
    log('=== Debut de l\'injection des donnees (1 AN) ===', 'section');

    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - 365); // 1 AN COMPLET (365 jours)

    // 1. CONFIG
    log('', '');
    log('[1/12] Configuration et utilisateurs...', 'section');
    const config = {
        etablissement: 'Cuisine Centrale College Victor Hugo',
        zones_temperature: ZONES_TEMP,
        zones_nettoyage: [
            { id: 'plan_travail', nom: 'Plan de travail' },
            { id: 'planches_decoupe', nom: 'Planches a decouper' },
            { id: 'lavabo', nom: 'Lavabo' },
            { id: 'plonge', nom: 'Plonge' },
            { id: 'surface_table', nom: 'Surface / Tables' },
            { id: 'sol', nom: 'Sol' },
            { id: 'four', nom: 'Four' },
            { id: 'friteuse', nom: 'Friteuse' },
            { id: 'hotte', nom: 'Hotte' },
            { id: 'trancheuse', nom: 'Trancheuse' },
            { id: 'chambre_froide', nom: 'Chambre froide' },
            { id: 'refrigerateurs', nom: 'Refrigerateurs' },
            { id: 'poignees_interrupteurs', nom: 'Poignees / Interrupteurs' },
            { id: 'vestiaire', nom: 'Vestiaire' },
            { id: 'sanitaires', nom: 'Sanitaires' },
            { id: 'poubelles', nom: 'Poubelles / Zone dechets' },
            { id: 'materiel', nom: 'Materiel / Ustensiles' }
        ],
        produits_nettoyage: PRODUITS_NET.concat(['Detartrant', 'Produit vitre']),
        categories_inventaire: [
            'Legumes', 'Fruits', 'Viandes', 'Poissons', 'Produits laitiers',
            'Epicerie seche', 'Surgeles', 'Boissons', 'Condiments', 'Pain',
            'Conserves', 'Produits d\'entretien', 'Consommables'
        ],
        unites: ['kg', 'g', 'L', 'cL', 'unite(s)', 'lot(s)', 'carton(s)', 'barquette(s)', 'sachet(s)'],
        fournisseurs_agrees: FOURNISSEURS,
        users: USERS
    };
    save('config', config);
    log(`  Etablissement: ${config.etablissement}`, 'ok');
    log(`  ${USERS.length} utilisateurs, ${FOURNISSEURS.length} fournisseurs agrees`, 'ok');

    // 2. TEMPERATURES ‚Äî 90 jours
    log('', '');
    log('[2/12] Temperatures (90 jours)...', 'section');
    let tempCount = 0;
    let tempDays = 0;
    const d = new Date(startDate);
    while (d <= today) {
        const ds = dateStr(d);
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        // Weekend: pas de releves (ou tres peu)
        if (isWeekend && Math.random() > 0.15) { d.setDate(d.getDate() + 1); continue; }
        // 5% de chances de jour manque
        if (Math.random() < 0.05) { d.setDate(d.getDate() + 1); continue; }

        tempDays++;
        const records = [];
        const operator = pick(USERS);
        // Matin (6h-8h) + midi (11h-12h) releves
        const heures = [{ h: 6, m: randBetween(0, 30) }, { h: 11, m: randBetween(0, 45) }];

        heures.forEach(heure => {
            // Choisir 6-9 zones aleatoirement
            const nbZones = 6 + Math.floor(Math.random() * 4);
            const zones = [...ZONES_TEMP].sort(() => Math.random() - 0.5).slice(0, nbZones);

            zones.forEach(zone => {
                let val;
                // 95% conformes, 4% attention, 1% critique
                const rand = Math.random();
                if (rand < 0.01) {
                    // Critique
                    if (zone.min < 0) val = randBetween(zone.max + 4, zone.max + 10);
                    else if (zone.min >= 63) val = randBetween(50, zone.min - 3);
                    else val = randBetween(zone.max + 3, zone.max + 8);
                } else if (rand < 0.05) {
                    // Attention
                    if (zone.min < 0) val = randBetween(zone.max + 0.5, zone.max + 3);
                    else if (zone.min >= 63) val = randBetween(zone.min - 2, zone.min);
                    else val = randBetween(zone.max + 0.5, zone.max + 2);
                } else {
                    // Conforme
                    val = randBetween(zone.min + 0.2, zone.max - 0.2);
                }

                records.push({
                    id: uid(),
                    zone_id: zone.id,
                    zone_nom: zone.nom,
                    valeur: +val.toFixed(1),
                    timestamp: isoAt(d, heure.h, Math.floor(heure.m)),
                    date: ds,
                    user: operator.nom
                });
                tempCount++;
            });
        });

        save('temp_' + ds, records);
        d.setDate(d.getDate() + 1);
    }
    log(`  ${tempCount} releves sur ${tempDays} jours (365 jours generes)`, 'ok');

    // 3. CCP
    log('', '');
    log('[3/12] CCP - Points critiques de controle...', 'section');
    let ccpCount = 0;
    const d2 = new Date(startDate);
    while (d2 <= today) {
        const ds = dateStr(d2);
        const isWeekend = d2.getDay() === 0 || d2.getDay() === 6;
        if (isWeekend) { d2.setDate(d2.getDate() + 1); continue; }
        if (Math.random() < 0.08) { d2.setDate(d2.getDate() + 1); continue; }

        const records = [];
        const operator = pick(USERS);
        // 1 a 3 CCP par jour
        const nb = 1 + Math.floor(Math.random() * 3);
        for (let i = 0; i < nb; i++) {
            const ccp = pick(CCP_PRODUITS);
            const temp = randBetween(ccp.temp_range[0], ccp.temp_range[1]);
            let conforme = true;
            if (ccp.type === 'cuisson' && temp < ccp.temp_cible) conforme = false;
            if (ccp.type === 'refroidissement' && temp > ccp.temp_cible) conforme = false;
            if (ccp.type === 'remise_temp' && temp < ccp.temp_cible) conforme = false;

            records.push({
                id: uid(),
                type_ccp: ccp.type,
                produit: ccp.produit,
                temp_mesuree: +temp.toFixed(1),
                temp_cible: ccp.temp_cible,
                conforme,
                timestamp: isoAt(d2, ccp.type === 'cuisson' ? 11 : ccp.type === 'refroidissement' ? 14 : 10, Math.floor(Math.random() * 50)),
                date: ds,
                user: operator.nom
            });
            ccpCount++;
        }
        save('ccp_' + ds, records);
        d2.setDate(d2.getDate() + 1);
    }
    log(`  ${ccpCount} controles CCP`, 'ok');

    // 4. NETTOYAGE
    log('', '');
    log('[4/12] Nettoyage (90 jours)...', 'section');
    let netCount = 0;
    let netDays = 0;
    const d3 = new Date(startDate);
    while (d3 <= today) {
        const ds = dateStr(d3);
        const isWeekend = d3.getDay() === 0 || d3.getDay() === 6;
        if (isWeekend && Math.random() > 0.1) { d3.setDate(d3.getDate() + 1); continue; }
        // 8% de jours sans nettoyage
        if (Math.random() < 0.08) { d3.setDate(d3.getDate() + 1); continue; }

        netDays++;
        const records = [];
        const operator = pick(USERS);
        // 2 a 4 sessions de nettoyage par jour
        const nbSessions = 2 + Math.floor(Math.random() * 3);
        const heuresNet = [7, 12, 15, 18];

        for (let s = 0; s < nbSessions; s++) {
            const nbZones = 3 + Math.floor(Math.random() * 6);
            const zonesChoisies = [...ZONES_NET].sort(() => Math.random() - 0.5).slice(0, nbZones);

            records.push({
                id: uid(),
                zones: zonesChoisies,
                produit: pick(PRODUITS_NET),
                timestamp: isoAt(d3, heuresNet[s] || 15, Math.floor(Math.random() * 50)),
                date: ds,
                user: operator.nom
            });
            netCount++;
        }
        save('net_' + ds, records);
        d3.setDate(d3.getDate() + 1);
    }
    log(`  ${netCount} sessions sur ${netDays} jours (365 jours generes)`, 'ok');

    // 5. RECEPTIONS
    log('', '');
    log('[5/12] Receptions de marchandises...', 'section');
    let recCount = 0;
    const d4 = new Date(startDate);
    while (d4 <= today) {
        const ds = dateStr(d4);
        const dow = d4.getDay();
        // Livraisons: lundi, mardi, mercredi, jeudi (pas vendredi/weekend)
        if (dow === 0 || dow === 5 || dow === 6) { d4.setDate(d4.getDate() + 1); continue; }
        // 70% de chances de livraison un jour ouvre
        if (Math.random() < 0.3) { d4.setDate(d4.getDate() + 1); continue; }

        const records = [];
        const operator = pick(USERS);
        const nbProduits = 1 + Math.floor(Math.random() * 4);
        const lotDate = ds.replace(/-/g, '');

        for (let i = 0; i < nbProduits; i++) {
            const prod = pick(PRODUITS_RECEPTION);
            const dlcDays = 3 + Math.floor(Math.random() * 25);
            const dlcDate = new Date(d4);
            dlcDate.setDate(dlcDate.getDate() + dlcDays);

            let temperature = null;
            let conforme = true;
            if (prod.temp_attendue !== null) {
                // 95% conforme
                if (Math.random() < 0.05) {
                    temperature = prod.temp_attendue + randBetween(3, 8);
                    conforme = false;
                } else {
                    temperature = prod.temp_attendue + randBetween(-1, 1.5);
                }
                temperature = +temperature.toFixed(1);
            }

            records.push({
                id: uid(),
                fournisseur: prod.fournisseur,
                produit: prod.produit,
                lot: 'L' + lotDate + '-' + (i + 1),
                dlc: dateStr(dlcDate),
                temperature,
                origine: 'France',
                conditionnement_ok: true,
                vehicule_propre: true,
                conforme,
                observations: conforme ? '' : 'Temperature de livraison non conforme ‚Äî produit accepte sous reserve',
                timestamp: isoAt(d4, 7 + Math.floor(Math.random() * 3), Math.floor(Math.random() * 50)),
                date: ds,
                user: operator.nom
            });
            recCount++;
        }
        save('rec_' + ds, records);
        d4.setDate(d4.getDate() + 1);
    }
    log(`  ${recCount} receptions`, 'ok');

    // 6. INVENTAIRE
    log('', '');
    log('[6/12] Inventaire...', 'section');
    const inventaire = [];
    INVENTAIRE_PRODUITS.forEach(p => {
        const dlcDays = p.categorie === 'Epicerie seche' || p.categorie === 'Condiments' || p.categorie === 'Conserves' || p.categorie === 'Consommables' || p.categorie === 'Produits d\'entretien'
            ? 60 + Math.floor(Math.random() * 300)
            : p.categorie === 'Surgeles'
                ? 30 + Math.floor(Math.random() * 120)
                : 1 + Math.floor(Math.random() * 12);
        const dlcDate = new Date(today);
        dlcDate.setDate(dlcDate.getDate() + dlcDays);

        // Quelques DLC depassees pour tester les alertes
        let finalDlc = dateStr(dlcDate);
        if (p.categorie === 'Legumes' && Math.random() < 0.15) {
            const pastDlc = new Date(today);
            pastDlc.setDate(pastDlc.getDate() - Math.floor(Math.random() * 3));
            finalDlc = dateStr(pastDlc);
        }

        inventaire.push({
            id: uid(),
            nom: p.nom,
            categorie: p.categorie,
            quantite: randBetween(p.qtyRange[0], p.qtyRange[1]),
            unite: p.unite,
            dlc: finalDlc,
            date_ajout: isoAt(new Date(today.getTime() - Math.random() * 30 * 86400000), 8, 0)
        });
    });
    save('inventaire', inventaire);
    log(`  ${inventaire.length} produits en stock`, 'ok');

    // 7. ALERTES
    log('', '');
    log('[7/12] Alertes et non-conformites...', 'section');
    const alertes = [];
    const alerteTemplates = [
        { type: 'temperature', niveau: 'critique', titre: 'Temperature congelateur trop haute', description: 'Congelateur a -12¬∞C au lieu de -18¬∞C min. Verifier le compresseur.', resolved: true, delay: 75 },
        { type: 'temperature', niveau: 'attention', titre: 'Frigo viandes a 4.5¬∞C', description: 'Temperature legerement au-dessus du seuil (max 3¬∞C). Porte mal fermee.', resolved: true, delay: 60 },
        { type: 'reception', niveau: 'attention', titre: 'Livraison poulet a 6¬∞C', description: 'Temperature de livraison non conforme. Produit accepte mais a utiliser en priorite.', resolved: true, delay: 45 },
        { type: 'temperature', niveau: 'critique', titre: 'Panne chambre froide positive', description: 'Temperature montee a 12¬∞C. Intervention technicien demandee.', resolved: true, delay: 35 },
        { type: 'nettoyage', niveau: 'attention', titre: 'Nettoyage hotte non effectue', description: 'Le nettoyage hebdomadaire de la hotte n\'a pas ete realise cette semaine.', resolved: true, delay: 30 },
        { type: 'reception', niveau: 'critique', titre: 'Lot de steaks haches rappele', description: 'Rappel fournisseur Charal lot L20251205-2. Produit isole et retourne.', resolved: true, delay: 20 },
        { type: 'temperature', niveau: 'attention', titre: 'Bain-marie a 58¬∞C', description: 'Maintien chaud insuffisant. Reglage thermostat effectue.', resolved: true, delay: 15 },
        { type: 'temperature', niveau: 'attention', titre: 'Frigo poissons a 3.5¬∞C', description: 'Temperature au-dessus du seuil (max 2¬∞C). Porte laissee ouverte.', resolved: false, delay: 2 },
        { type: 'manuelle', niveau: 'attention', titre: 'Joint de porte frigo a changer', description: 'Joint du frigo legumes abime, perte de froid constatee.', resolved: false, delay: 5 }
    ];

    alerteTemplates.forEach(tpl => {
        const created = new Date(today);
        created.setDate(created.getDate() - tpl.delay);
        const alerte = {
            id: uid(),
            type: tpl.type,
            niveau: tpl.niveau,
            titre: tpl.titre,
            description: tpl.description,
            timestamp: isoAt(created, 8 + Math.floor(Math.random() * 4), Math.floor(Math.random() * 50)),
            resolved: tpl.resolved,
            user: pick(USERS).nom
        };
        if (tpl.resolved) {
            const resolvedDate = new Date(created);
            resolvedDate.setDate(resolvedDate.getDate() + Math.floor(Math.random() * 3) + 1);
            alerte.resolved_at = isoAt(resolvedDate, 9 + Math.floor(Math.random() * 6), Math.floor(Math.random() * 50));
            alerte.resolved_by = pick(USERS).nom;
            alerte.resolved_comment = pick([
                'Probleme corrige. Thermostat regle.',
                'Intervention technicien effectuee.',
                'Produit isole et detruit. Fournisseur contacte.',
                'Nettoyage rattrape. Rappel equipe effectue.',
                'Porte reparee. Temperature revenue a la normale.',
                'Reglage effectue. A surveiller.'
            ]);
        }
        alertes.push(alerte);
    });
    save('alertes', alertes);
    log(`  ${alertes.length} alertes (${alertes.filter(a => !a.resolved).length} actives)`, 'ok');

    // 8. ALLERGENES
    log('', '');
    log('[8/12] Plats et allergenes...', 'section');
    const plats = PLATS_ALLERGENES.map(p => ({
        id: uid(),
        nom: p.nom,
        categorie: p.categorie,
        allergenes: p.allergenes,
        ingredients: p.ingredients,
        date_ajout: isoAt(new Date(today.getTime() - 60 * 86400000), 10, 0)
    }));
    save('allergene_plats', plats);
    log(`  ${plats.length} plats avec allergenes declares`, 'ok');

    // 9. ETIQUETTES DECONDITIONEMENT
    log('', '');
    log('[9/12] Etiquettes de deconditionement...', 'section');
    const etiquettes = [];
    for (let i = 0; i < 25; i++) {
        const etiqData = pick(ETIQ_PRODUITS);
        const dateDecond = new Date(today);
        dateDecond.setDate(dateDecond.getDate() - Math.floor(Math.random() * 60));
        const dlcSec = new Date(dateDecond);
        dlcSec.setDate(dlcSec.getDate() + 3); // J+3

        etiquettes.push({
            id: uid(),
            produit: etiqData.produit,
            origine: etiqData.origine,
            date_deconditionement: dateStr(dateDecond),
            dlc_secondaire: dateStr(dlcSec),
            temperature_stockage: etiqData.temperature_stockage,
            lot: 'L' + dateStr(dateDecond).replace(/-/g, '') + '-' + (i + 1),
            timestamp: isoAt(dateDecond, 8 + Math.floor(Math.random() * 3), Math.floor(Math.random() * 50)),
            user: pick(USERS).nom
        });
    }
    save('etiquettes', etiquettes);
    log(`  ${etiquettes.length} etiquettes`, 'ok');

    // 10. PLATS TEMOINS
    log('', '');
    log('[10/12] Plats temoins...', 'section');
    const platsTemoins = [];
    const d6 = new Date(startDate);
    while (d6 <= today) {
        const isWeekend = d6.getDay() === 0 || d6.getDay() === 6;
        if (!isWeekend && Math.random() > 0.2) {
            platsTemoins.push({
                id: uid(),
                plat: pick(TEMOIN_PLATS),
                date_service: dateStr(d6),
                heure_service: '12:00',
                conserve_jusqu: dateStr(new Date(d6.getTime() + 5 * 86400000)),
                timestamp: isoAt(d6, 12, Math.floor(Math.random() * 30)),
                user: pick(USERS).nom
            });
        }
        d6.setDate(d6.getDate() + 1);
    }
    save('plats_temoins', platsTemoins);
    log(`  ${platsTemoins.length} plats temoins preleves`, 'ok');

    // 11. CONTROLES HUILES
    log('', '');
    log('[11/12] Controles huiles de friture...', 'section');
    const controlesHuiles = [];
    for (let w = 0; w < 12; w++) {
        const dateCtrl = new Date(today);
        dateCtrl.setDate(dateCtrl.getDate() - w * 7 - Math.floor(Math.random() * 2));
        const taux = randBetween(8, 22);

        controlesHuiles.push({
            id: uid(),
            friteuse: 'Friteuse principale',
            taux_polaire: +taux.toFixed(0),
            resultat: taux > 25 ? 'Changer' : taux > 20 ? 'Limite' : 'OK',
            action: taux > 20 ? 'Huile changee' : 'RAS',
            timestamp: isoAt(dateCtrl, 14, Math.floor(Math.random() * 50)),
            user: pick(USERS).nom
        });
    }
    save('controles_huiles', controlesHuiles);
    log(`  ${controlesHuiles.length} controles huile`, 'ok');

    // 12. MENUS
    log('', '');
    log('[12/12] Menus generes...', 'section');
    let menuCount = 0;
    // Un menu par semaine (lundi) sur les 52 dernieres semaines (1 AN)
    for (let w = 0; w < 52; w++) {
        const mondayDate = new Date(today);
        // Trouver le lundi de cette semaine-la
        const daysSinceMonday = (mondayDate.getDay() + 6) % 7;
        mondayDate.setDate(mondayDate.getDate() - daysSinceMonday - w * 7);
        const ds = dateStr(mondayDate);

        const menuTemplate = MENU_THEMES[w % MENU_THEMES.length];
        const menu = {
            semaine: 1,
            theme_id: menuTemplate.theme_id,
            theme_nom: menuTemplate.theme_nom,
            collectivite_id: menuTemplate.collectivite_id,
            collectivite_nom: menuTemplate.collectivite_nom,
            jours: menuTemplate.jours,
            date_generation: isoAt(new Date(mondayDate.getTime() - 3 * 86400000), 10, 0),
            user: 'Chef Martin'
        };
        save('menus_' + ds, [menu]);
        menuCount++;
    }
    log(`  ${menuCount} semaines de menus (52 semaines = 1 AN)`, 'ok');

    // 13. JOURNAL ‚Äî generer les entrees correspondantes
    log('', '');
    log('[BONUS] Journal des actions...', 'section');
    let journalCount = 0;
    const d7 = new Date(startDate);
    while (d7 <= today) {
        const ds = dateStr(d7);
        const isWeekend = d7.getDay() === 0 || d7.getDay() === 6;
        if (isWeekend) { d7.setDate(d7.getDate() + 1); continue; }

        const entries = [];
        const operator = pick(USERS);

        // Connexion matin
        entries.push({
            id: uid(), type: 'connexion',
            message: `Connexion de ${operator.nom}`,
            timestamp: isoAt(d7, 6, Math.floor(Math.random() * 30)),
            user: operator.nom
        });

        // Temperatures
        entries.push({
            id: uid(), type: 'temperature',
            message: `Releves temperatures du matin effectues`,
            timestamp: isoAt(d7, 6, 30 + Math.floor(Math.random() * 20)),
            user: operator.nom
        });

        // Nettoyage
        if (Math.random() > 0.1) {
            entries.push({
                id: uid(), type: 'nettoyage',
                message: `Nettoyage zones cuisine valide`,
                timestamp: isoAt(d7, 7, Math.floor(Math.random() * 50)),
                user: pick(USERS).nom
            });
        }

        // Reception eventuelle
        if (d7.getDay() >= 1 && d7.getDay() <= 4 && Math.random() > 0.4) {
            const fourn = pick(FOURNISSEURS);
            entries.push({
                id: uid(), type: 'reception',
                message: `Reception ${fourn.nom} ‚Äî controle effectue`,
                timestamp: isoAt(d7, 7 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 50)),
                user: operator.nom
            });
        }

        // CCP midi
        entries.push({
            id: uid(), type: 'ccp',
            message: `Controle CCP cuisson effectue`,
            timestamp: isoAt(d7, 11, Math.floor(Math.random() * 40)),
            user: operator.nom
        });

        // Temperatures midi
        entries.push({
            id: uid(), type: 'temperature',
            message: `Releves temperatures du midi effectues`,
            timestamp: isoAt(d7, 11, 30 + Math.floor(Math.random() * 25)),
            user: operator.nom
        });

        // Nettoyage apres service
        entries.push({
            id: uid(), type: 'nettoyage',
            message: `Nettoyage apres service valide`,
            timestamp: isoAt(d7, 14, Math.floor(Math.random() * 50)),
            user: pick(USERS).nom
        });

        // Deconnexion
        entries.push({
            id: uid(), type: 'connexion',
            message: `Deconnexion de ${operator.nom}`,
            timestamp: isoAt(d7, 16 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 50)),
            user: operator.nom
        });

        save('journal_' + ds, entries);
        journalCount += entries.length;
        d7.setDate(d7.getDate() + 1);
    }
    log(`  ${journalCount} entrees de journal`, 'ok');

    // RESUME
    log('', '');
    log('=== INJECTION TERMINEE ===', 'section');
    log('', '');
    log('Donnees injectees avec succes ! Ouvrez l\'application pour les voir.', 'ok');
    log(`Connexion: Chef Martin / PIN: 1234 (admin)`, 'info');
    log(`Connexion: Sophie Durand / PIN: 5678`, 'info');
    log(`Connexion: Karim Benali / PIN: 9012`, 'info');
    log(`Connexion: Marie Lefebvre / PIN: 3456`, 'info');
}

// ========== SCENARIO INJECTION ==========
function injectScenario(scenarioId) {
    const scenario = SCENARIOS[scenarioId];
    if (!scenario) {
        log('Scenario inconnu !', 'warn');
        return;
    }

    logEl.innerHTML = '';
    log(`=== Injection du scenario: ${scenario.nom} ===`, 'section');
    log(`Etablissement: ${scenario.etablissement}`, 'info');
    log(`Type: ${scenario.type} - ${scenario.effectif} personnes`, 'info');
    log(`Periode: ${scenario.jours} jours`, 'info');
    log('', '');

    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - scenario.jours);

    // 1. CONFIG
    log('[1/12] Configuration et utilisateurs...', 'section');
    const config = {
        etablissement: scenario.etablissement,
        zones_temperature: ZONES_TEMP,
        zones_nettoyage: [
            { id: 'plan_travail', nom: 'Plan de travail' },
            { id: 'planches_decoupe', nom: 'Planches a decouper' },
            { id: 'lavabo', nom: 'Lavabo' },
            { id: 'plonge', nom: 'Plonge' },
            { id: 'surface_table', nom: 'Surface / Tables' },
            { id: 'sol', nom: 'Sol' },
            { id: 'four', nom: 'Four' },
            { id: 'friteuse', nom: 'Friteuse' },
            { id: 'hotte', nom: 'Hotte' },
            { id: 'trancheuse', nom: 'Trancheuse' },
            { id: 'chambre_froide', nom: 'Chambre froide' },
            { id: 'refrigerateurs', nom: 'Refrigerateurs' },
            { id: 'poignees_interrupteurs', nom: 'Poignees / Interrupteurs' },
            { id: 'vestiaire', nom: 'Vestiaire' },
            { id: 'sanitaires', nom: 'Sanitaires' },
            { id: 'poubelles', nom: 'Poubelles / Zone dechets' },
            { id: 'materiel', nom: 'Materiel / Ustensiles' }
        ],
        produits_nettoyage: PRODUITS_NET.concat(['Detartrant', 'Produit vitre']),
        categories_inventaire: [
            'Legumes', 'Fruits', 'Viandes', 'Poissons', 'Produits laitiers',
            'Epicerie seche', 'Surgeles', 'Boissons', 'Condiments', 'Pain',
            'Conserves', 'Produits d\'entretien', 'Consommables'
        ],
        unites: ['kg', 'g', 'L', 'cL', 'unite(s)', 'lot(s)', 'carton(s)', 'barquette(s)', 'sachet(s)'],
        fournisseurs_agrees: FOURNISSEURS,
        users: USERS
    };
    save('config', config);
    log(`  Etablissement: ${config.etablissement}`, 'ok');
    log(`  ${USERS.length} utilisateurs, ${FOURNISSEURS.length} fournisseurs agrees`, 'ok');

    // 2. TEMPERATURES
    log('', '');
    log(`[2/12] Temperatures (${scenario.jours} jours)...`, 'section');
    let tempCount = 0;
    let tempDays = 0;
    const d = new Date(startDate);
    while (d <= today) {
        const ds = dateStr(d);
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        if (isWeekend) { d.setDate(d.getDate() + 1); continue; }
        if (Math.random() < 0.05) { d.setDate(d.getDate() + 1); continue; }

        tempDays++;
        const records = [];
        const operator = pick(USERS);

        const horairesMatin = [{ h: 6, m: 0 }, { h: 7, m: 0 }];
        const horairesMidi = [{ h: 11, m: 0 }, { h: 12, m: 0 }];
        const horaires = horairesMatin.concat(horairesMidi);

        ZONES_TEMP.forEach(zone => {
            horaires.forEach(heure => {
                let val;
                // Introduce incidents if scenario has incidents flag
                if (scenario.incidents && Math.random() < 0.08) {
                    // Temperature alert
                    val = zone.min < 0 ? randBetween(zone.max + 2, zone.max + 8) : randBetween(zone.max + 1, zone.max + 4);
                } else {
                    val = randBetween(zone.min, zone.max);
                }
                records.push({
                    id: uid(),
                    zone_id: zone.id,
                    zone_nom: zone.nom,
                    valeur: +val.toFixed(1),
                    timestamp: isoAt(d, heure.h, Math.floor(heure.m)),
                    date: ds,
                    user: operator.nom
                });
                tempCount++;
            });
        });

        save('temp_' + ds, records);
        d.setDate(d.getDate() + 1);
    }
    log(`  ${tempCount} releves sur ${tempDays} jours`, 'ok');

    // 3. CCP
    log('', '');
    log('[3/12] CCP - Points critiques de controle...', 'section');
    let ccpCount = 0;
    const d2 = new Date(startDate);
    while (d2 <= today) {
        const ds = dateStr(d2);
        const isWeekend = d2.getDay() === 0 || d2.getDay() === 6;
        if (isWeekend) { d2.setDate(d2.getDate() + 1); continue; }
        if (Math.random() < 0.08) { d2.setDate(d2.getDate() + 1); continue; }

        const records = [];
        const operator = pick(USERS);
        const nbCCP = 1 + Math.floor(Math.random() * 3);
        for (let i = 0; i < nbCCP; i++) {
            const ccp = pick(CCP_PRODUITS);
            const temp = randBetween(ccp.temp_range[0], ccp.temp_range[1]);
            const heureCCP = ccp.type === 'cuisson' ? randBetween(11, 12) : randBetween(13, 15);
            records.push({
                id: uid(),
                type: ccp.type,
                produit: ccp.produit,
                temperature: +temp.toFixed(1),
                timestamp: isoAt(d2, Math.floor(heureCCP), Math.floor(Math.random() * 50)),
                date: ds,
                user: operator.nom
            });
            ccpCount++;
        }
        save('ccp_' + ds, records);
        d2.setDate(d2.getDate() + 1);
    }
    log(`  ${ccpCount} controles CCP`, 'ok');

    // 4. NETTOYAGE
    log('', '');
    log('[4/12] Nettoyage...', 'section');
    let netCount = 0;
    let netDays = 0;
    const d3 = new Date(startDate);
    while (d3 <= today) {
        const ds = dateStr(d3);
        const isWeekend = d3.getDay() === 0 || d3.getDay() === 6;
        if (isWeekend) { d3.setDate(d3.getDate() + 1); continue; }
        if (Math.random() < 0.05) { d3.setDate(d3.getDate() + 1); continue; }

        netDays++;
        const records = [];
        const operator = pick(USERS);
        const sessions = scenario.excellence ? 4 : (1 + Math.floor(Math.random() * 3));
        const heuresNet = [7, 11, 14, 17];

        for (let s = 0; s < sessions; s++) {
            const nbZones = 3 + Math.floor(Math.random() * 8);
            const zonesChoisies = [...ZONES_NET].sort(() => Math.random() - 0.5).slice(0, nbZones);

            records.push({
                id: uid(),
                zones: zonesChoisies,
                produit: pick(PRODUITS_NET),
                timestamp: isoAt(d3, heuresNet[s] || 15, Math.floor(Math.random() * 50)),
                date: ds,
                user: operator.nom
            });
            netCount++;
        }
        save('net_' + ds, records);
        d3.setDate(d3.getDate() + 1);
    }
    log(`  ${netCount} sessions de nettoyage sur ${netDays} jours`, 'ok');

    // 5. RECEPTIONS
    log('', '');
    log('[5/12] Receptions de marchandises...', 'section');
    let recCount = 0;
    const d4 = new Date(startDate);
    while (d4 <= today) {
        const ds = dateStr(d4);
        const dow = d4.getDay();
        if (dow === 0 || dow === 5 || dow === 6) { d4.setDate(d4.getDate() + 1); continue; }
        if (Math.random() < 0.3) { d4.setDate(d4.getDate() + 1); continue; }

        const records = [];
        const nbLivraisons = scenario.multisites ? (2 + Math.floor(Math.random() * 3)) : (1 + Math.floor(Math.random() * 2));
        for (let i = 0; i < nbLivraisons; i++) {
            const fourn = pick(FOURNISSEURS);
            const produitLivre = pick(PRODUITS_RECEPTION);
            records.push({
                id: uid(),
                fournisseur: fourn.nom,
                fournisseur_agrement: fourn.agrement,
                produit: produitLivre.produit,
                origine: produitLivre.origine,
                temperature_stockage: produitLivre.temperature_stockage,
                conforme: scenario.incidents && Math.random() < 0.05 ? false : true,
                timestamp: isoAt(d4, 7 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 50)),
                date: ds,
                user: pick(USERS).nom
            });
            recCount++;
        }
        save('rec_' + ds, records);
        d4.setDate(d4.getDate() + 1);
    }
    log(`  ${recCount} receptions`, 'ok');

    // 6. TRACABILITE
    log('', '');
    log('[6/12] Tracabilite (plats temoins)...', 'section');
    let tracCount = 0;
    const d5 = new Date(startDate);
    while (d5 <= today) {
        const ds = dateStr(d5);
        const isWeekend = d5.getDay() === 0 || d5.getDay() === 6;
        if (isWeekend) { d5.setDate(d5.getDate() + 1); continue; }
        if (Math.random() < 0.08) { d5.setDate(d5.getDate() + 1); continue; }

        const records = [];
        const platDuJour = pick(TEMOIN_PLATS);
        records.push({
            id: uid(),
            plat: platDuJour,
            date_prelevee: ds,
            timestamp: isoAt(d5, 12, 30 + Math.floor(Math.random() * 20)),
            user: pick(USERS).nom
        });
        tracCount++;
        save('trac_' + ds, records);
        d5.setDate(d5.getDate() + 1);
    }
    log(`  ${tracCount} plats temoins`, 'ok');

    // 7. MENUS
    log('', '');
    log('[7/12] Menus de la semaine...', 'section');
    const menuSemaine = MENU_THEMES[0];
    save('menus_actifs', [menuSemaine]);
    log(`  Menu "${menuSemaine.theme_nom}" active`, 'ok');

    // 8. INVENTAIRE
    log('', '');
    log('[8/12] Inventaire...', 'section');
    const invData = [];
    INVENTAIRE_PRODUITS.forEach(p => {
        const qty = +(p.qtyRange[0] + Math.random() * (p.qtyRange[1] - p.qtyRange[0])).toFixed(1);
        invData.push({
            id: uid(),
            nom: p.nom,
            categorie: p.categorie,
            quantite: qty,
            unite: p.unite,
            derniere_maj: today.toISOString()
        });
    });
    save('inventaire', invData);
    log(`  ${invData.length} produits en stock`, 'ok');

    // 9. FOURNISSEURS
    log('', '');
    log('[9/12] Fournisseurs agrees...', 'section');
    save('fournisseurs', FOURNISSEURS);
    log(`  ${FOURNISSEURS.length} fournisseurs`, 'ok');

    // 10. PAI (pour maternelle/creche)
    log('', '');
    log('[10/12] PAI - Projets d\'Accueil Individualise...', 'section');
    const paiData = [];
    if (scenario.type === 'maternelle' || scenario.type === 'creche') {
        const nbPAI = scenario.pai ? Math.floor(scenario.effectif * 0.15) : Math.floor(scenario.effectif * 0.08);
        for (let i = 0; i < nbPAI; i++) {
            paiData.push({
                id: uid(),
                nom: `Enfant PAI ${i + 1}`,
                allergenes: [pick(['arachide', 'lait', 'oeufs', 'gluten', 'fruits a coque'])],
                mesures: 'Eviction complete, substituts prevus',
                date_creation: dateStr(new Date(startDate.getTime() + Math.random() * (today.getTime() - startDate.getTime())))
            });
        }
    }
    save('pai', paiData);
    log(`  ${paiData.length} PAI enregistres`, 'ok');

    // 11. FORMATIONS
    log('', '');
    log('[11/12] Formations...', 'section');
    const formData = [];
    const nbFormations = scenario.professionnel ? 8 : 3;
    for (let i = 0; i < nbFormations; i++) {
        const dateForm = new Date(startDate.getTime() + Math.random() * (today.getTime() - startDate.getTime()));
        formData.push({
            id: uid(),
            titre: pick(['HACCP', 'Allergenes', 'Hygiene', 'PMS', 'Tracabilite', 'Gestion stocks', 'Premiers secours']),
            date: dateStr(dateForm),
            participants: [pick(USERS).nom, pick(USERS).nom],
            duree: '3h',
            organisme: 'CEFORA'
        });
    }
    save('formations', formData);
    log(`  ${formData.length} formations`, 'ok');

    // 12. ALERTES
    log('', '');
    log('[12/21] Alertes...', 'section');
    const alertes = [];
    if (scenario.incidents) {
        const nbAlertes = Math.floor(scenario.jours / 10);
        for (let i = 0; i < nbAlertes; i++) {
            const dateAlert = new Date(startDate.getTime() + Math.random() * (today.getTime() - startDate.getTime()));
            alertes.push({
                id: uid(),
                type: pick(['temperature', 'dlc', 'hygiene', 'materiel']),
                message: pick([
                    'Temperature hors normes detectee',
                    'Produit proche de la DLC',
                    'Non-conformite hygiene',
                    'Equipement defaillant'
                ]),
                date: dateStr(dateAlert),
                timestamp: dateAlert.toISOString(),
                statut: Math.random() > 0.3 ? 'resolue' : 'en_cours',
                user: pick(USERS).nom
            });
        }
    }
    save('alertes', alertes);
    log(`  ${alertes.length} alertes generees`, 'ok');

    // 13. PLATS ALLERGENES
    log('', '');
    log('[13/21] Plats et allergenes...', 'section');
    save('allergene_plats', PLATS_ALLERGENES);
    log(`  ${PLATS_ALLERGENES.length} plats avec allergenes references`, 'ok');

    // 14. ETIQUETTES
    log('', '');
    log('[14/21] Etiquettes...', 'section');
    const etiquettes = [];
    const d_etiq = new Date(startDate);
    let etiqCount = 0;
    while (d_etiq <= today && etiqCount < 30) {
        const ds = dateStr(d_etiq);
        const isWeekend = d_etiq.getDay() === 0 || d_etiq.getDay() === 6;
        if (!isWeekend && Math.random() > 0.7) {
            etiquettes.push({
                id: uid(),
                plat: pick(TEMOIN_PLATS),
                date_fabrication: ds,
                date_limite: dateStr(new Date(d_etiq.getTime() + 3 * 24 * 60 * 60 * 1000)),
                temperature: '+3¬∞C',
                allergenes: pick(['Lait', 'Gluten', 'Oeufs', 'Aucun']),
                timestamp: d_etiq.toISOString()
            });
            etiqCount++;
        }
        d_etiq.setDate(d_etiq.getDate() + 1);
    }
    save('etiquettes', etiquettes);
    log(`  ${etiquettes.length} etiquettes`, 'ok');

    // 15. CONTROLES HUILES
    log('', '');
    log('[15/21] Controles huiles de friture...', 'section');
    const controlesHuiles = [];
    const d_huile = new Date(startDate);
    while (d_huile <= today) {
        const ds = dateStr(d_huile);
        const isWeekend = d_huile.getDay() === 0 || d_huile.getDay() === 6;
        if (!isWeekend && Math.random() > 0.8) {
            controlesHuiles.push({
                id: uid(),
                date: ds,
                valeur: +(20 + Math.random() * 5).toFixed(1),
                conforme: true,
                timestamp: isoAt(d_huile, 11, Math.floor(Math.random() * 30)),
                user: pick(USERS).nom
            });
        }
        d_huile.setDate(d_huile.getDate() + 1);
    }
    save('controles_huiles', controlesHuiles);
    log(`  ${controlesHuiles.length} controles huiles`, 'ok');

    // 16. MAINTENANCE
    log('', '');
    log('[16/21] Maintenance des equipements...', 'section');
    const maintenances = [];
    const equipements = [
        'Four professionnel', 'Chambre froide positive', 'Chambre froide negative',
        'Friteuse', 'Lave-vaisselle', 'Trancheuse', 'Robot coupe', 'Cellule de refroidissement'
    ];
    equipements.forEach(equip => {
        const nbMaintenances = 2 + Math.floor(Math.random() * 3);
        for (let i = 0; i < nbMaintenances; i++) {
            const dateMain = new Date(startDate.getTime() + Math.random() * (today.getTime() - startDate.getTime()));
            maintenances.push({
                id: uid(),
                equipement: equip,
                type: pick(['Preventive', 'Curative', 'Verification']),
                date: dateStr(dateMain),
                intervenant: pick(['Maintenance interne', 'SOCOTEC', 'Froid Services', 'Technicien agree']),
                conforme: Math.random() > 0.1,
                observations: pick(['RAS', 'Intervention realisee', 'Pieces remplacees', 'Reglages effectues']),
                timestamp: dateMain.toISOString()
            });
        }
    });
    save('maintenances', maintenances);
    log(`  ${maintenances.length} operations de maintenance`, 'ok');

    // 17. DOUCHES ET VESTIAIRES
    log('', '');
    log('[17/21] Controles douches et vestiaires...', 'section');
    const douchesVestiaires = [];
    const d_douche = new Date(startDate);
    while (d_douche <= today) {
        const ds = dateStr(d_douche);
        const isWeekend = d_douche.getDay() === 0 || d_douche.getDay() === 6;
        if (!isWeekend && Math.random() > 0.7) {
            douchesVestiaires.push({
                id: uid(),
                date: ds,
                vestiaires_propres: true,
                douches_fonctionnelles: true,
                eau_chaude: true,
                savon_disponible: true,
                essuie_mains: true,
                observations: 'RAS',
                timestamp: isoAt(d_douche, 6, Math.floor(Math.random() * 30)),
                user: pick(USERS).nom
            });
        }
        d_douche.setDate(d_douche.getDate() + 1);
    }
    save('douches_vestiaires', douchesVestiaires);
    log(`  ${douchesVestiaires.length} controles vestiaires`, 'ok');

    // 18. GASPILLAGE
    log('', '');
    log('[18/21] Suivi du gaspillage alimentaire...', 'section');
    const gaspillage = [];
    const d_gasp = new Date(startDate);
    while (d_gasp <= today) {
        const ds = dateStr(d_gasp);
        const isWeekend = d_gasp.getDay() === 0 || d_gasp.getDay() === 6;
        if (!isWeekend && Math.random() > 0.5) {
            gaspillage.push({
                id: uid(),
                date: ds,
                poids_total: +(5 + Math.random() * 15).toFixed(1),
                detail: {
                    entrees: +(1 + Math.random() * 3).toFixed(1),
                    plats: +(2 + Math.random() * 5).toFixed(1),
                    accompagnements: +(1 + Math.random() * 4).toFixed(1),
                    desserts: +(1 + Math.random() * 3).toFixed(1)
                },
                observations: pick(['Service normal', 'Plat peu apprecie', 'Portions trop grandes', 'RAS']),
                timestamp: isoAt(d_gasp, 13, Math.floor(Math.random() * 30)),
                user: pick(USERS).nom
            });
        }
        d_gasp.setDate(d_gasp.getDate() + 1);
    }
    save('gaspillage', gaspillage);
    log(`  ${gaspillage.length} releves de gaspillage`, 'ok');

    // 19. COUVERTS
    log('', '');
    log('[19/21] Nombre de couverts servis...', 'section');
    const couverts = [];
    const d_couv = new Date(startDate);
    while (d_couv <= today) {
        const ds = dateStr(d_couv);
        const isWeekend = d_couv.getDay() === 0 || d_couv.getDay() === 6;
        if (!isWeekend && Math.random() > 0.2) {
            const tauxPresence = 0.85 + Math.random() * 0.1;
            couverts.push({
                id: uid(),
                date: ds,
                nombre: Math.floor(scenario.effectif * tauxPresence),
                service: pick(['Midi', 'Soir', 'Gouter']),
                timestamp: isoAt(d_couv, 12, Math.floor(Math.random() * 30))
            });
        }
        d_couv.setDate(d_couv.getDate() + 1);
    }
    save('couverts', couverts);
    log(`  ${couverts.length} services enregistres`, 'ok');

    // 20. TIAC (incidents)
    log('', '');
    log('[20/21] TIAC - Toxi-infections alimentaires...', 'section');
    const tiac = [];
    if (scenario.incidents) {
        // Generer 1-2 incidents TIAC pour scenarios avec incidents
        const nbTIAC = Math.random() > 0.5 ? 1 : 2;
        for (let i = 0; i < nbTIAC; i++) {
            const dateTIAC = new Date(startDate.getTime() + Math.random() * (today.getTime() - startDate.getTime()));
            tiac.push({
                id: uid(),
                date_declaration: dateStr(dateTIAC),
                date_suspicion: dateStr(new Date(dateTIAC.getTime() - 24 * 60 * 60 * 1000)),
                nb_personnes: Math.floor(5 + Math.random() * 15),
                symptomes: ['Nausees', 'Vomissements', 'Diarrhee'],
                aliment_suspecte: pick(TEMOIN_PLATS),
                mesures_prises: 'Declaration ARS, enquete en cours, retrait plat',
                statut: 'cloture',
                timestamp: dateTIAC.toISOString()
            });
        }
    }
    save('tiac', tiac);
    log(`  ${tiac.length} declarations TIAC`, 'ok');

    // 21. ANALYSE DE RISQUES
    log('', '');
    log('[21/21] Analyse de risques...', 'section');
    const analyseRisques = [];
    const risques = [
        { danger: 'Contamination croisee', criticite: 'Haute', mesures: 'Separation stricte cru/cuit, plans de travail dedies' },
        { danger: 'Rupture chaine du froid', criticite: 'Haute', mesures: 'Releves temperatures reguliers, alertes automatiques' },
        { danger: 'Cuisson insuffisante', criticite: 'Haute', mesures: 'Controle CCP systematique, sondes etalonnees' },
        { danger: 'Hygiene du personnel', criticite: 'Moyenne', mesures: 'Formation HACCP, tenue reglementaire, lavage mains' },
        { danger: 'Nuisibles', criticite: 'Moyenne', mesures: 'Contrat desinsectisation, pieges, controles mensuels' }
    ];
    risques.forEach((r, idx) => {
        analyseRisques.push({
            id: uid(),
            numero: idx + 1,
            danger: r.danger,
            criticite: r.criticite,
            mesures_preventives: r.mesures,
            frequence_controle: 'Quotidienne',
            responsable: pick(USERS).nom,
            date_evaluation: dateStr(startDate)
        });
    });
    save('analyse_risques', analyseRisques);
    log(`  ${analyseRisques.length} risques analyses`, 'ok');

    // MODULES COMPLEMENTAIRES
    // Separation cru/cuit
    save('separation_plans', [{
        id: uid(),
        titre: 'Plan de separation cru/cuit',
        zones_cru: ['Zone preparation viandes', 'Zone preparation poissons', 'Refrigerateur cru'],
        zones_cuit: ['Zone cuisson', 'Zone assemblage', 'Refrigerateur cuit'],
        materiel_dedie: true,
        date_creation: dateStr(startDate)
    }]);

    // Recettes
    const recettes = [
        { id: uid(), nom: 'Poulet roti', ingredients: 'Poulet, herbes, sel, poivre', portions: 10, temps: '1h30' },
        { id: uid(), nom: 'Gratin dauphinois', ingredients: 'Pommes de terre, creme, lait, ail', portions: 20, temps: '1h' },
        { id: uid(), nom: 'Ratatouille', ingredients: 'Aubergines, courgettes, tomates, poivrons', portions: 15, temps: '45min' }
    ];
    save('recettes', recettes);

    // RGPD
    save('rgpd_consentements', []);
    save('rgpd_registre', [{
        id: uid(),
        traitement: 'Gestion des donnees du personnel',
        finalite: 'Gestion administrative',
        base_legale: 'Obligation legale',
        date: dateStr(today)
    }]);

    // AGEC (dons alimentaires)
    const agecDons = [];
    if (scenario.bio || scenario.type === 'lycee') {
        const d_agec = new Date(startDate);
        while (d_agec <= today) {
            const ds = dateStr(d_agec);
            if (d_agec.getDay() === 5 && Math.random() > 0.6) { // Vendredi
                agecDons.push({
                    id: uid(),
                    date: ds,
                    association: pick(['Restos du Coeur', 'Banque Alimentaire', 'Secours Populaire']),
                    poids: +(10 + Math.random() * 30).toFixed(1),
                    produits: pick(['Excedents pain', 'Fruits et legumes', 'Plats prepares']),
                    timestamp: isoAt(d_agec, 17, Math.floor(Math.random() * 30))
                });
            }
            d_agec.setDate(d_agec.getDate() + 1);
        }
    }
    save('agec_dons', agecDons);

    // Rappels produits
    const rappels = [];
    if (scenario.incidents) {
        rappels.push({
            id: uid(),
            produit: 'Steaks haches congeles',
            lot: 'LOT2024A123',
            fournisseur: 'Charal',
            motif: 'Presence potentielle E. coli',
            date_rappel: dateStr(new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000)),
            action: 'Retrait stock, verification lots',
            statut: 'traite'
        });
    }
    save('rappels_produits', rappels);

    // Archives DLC
    const archivesDLC = [];
    const d_dlc = new Date(startDate);
    let dlcCount = 0;
    while (d_dlc <= today && dlcCount < 20) {
        if (Math.random() > 0.8) {
            archivesDLC.push({
                id: uid(),
                produit: pick(['Yaourt nature', 'Creme fraiche', 'Jambon', 'Fromage blanc']),
                dlc: dateStr(d_dlc),
                action: pick(['Consomme', 'Jete', 'Don']),
                date_action: dateStr(d_dlc)
            });
            dlcCount++;
        }
        d_dlc.setDate(d_dlc.getDate() + 1);
    }
    save('archives_dlc', archivesDLC);

    // Validation nettoyages (module complementaire)
    save('validation_nettoyages', []);

    // Protocoles
    save('protocoles', [
        { id: uid(), nom: 'Protocole nettoyage plan de travail', etapes: ['Debarrasser', 'Laver', 'Desinfecter', 'Rincer', 'Secher'] },
        { id: uid(), nom: 'Protocole reception marchandises', etapes: ['Controler temperature', 'Verifier DLC', 'Controler integrite', 'Enregistrer'] }
    ]);

    // 22. JOURNAL
    log('', '');
    log('[22/22] Journal des actions...', 'section');
    let journalCount = 0;
    const d7 = new Date(startDate);
    while (d7 <= today) {
        const ds = dateStr(d7);
        const isWeekend = d7.getDay() === 0 || d7.getDay() === 6;
        if (isWeekend) { d7.setDate(d7.getDate() + 1); continue; }

        const entries = [];
        const operator = pick(USERS);

        entries.push({
            id: uid(), type: 'connexion',
            message: `Connexion de ${operator.nom}`,
            timestamp: isoAt(d7, 6, Math.floor(Math.random() * 30)),
            user: operator.nom
        });

        entries.push({
            id: uid(), type: 'temperature',
            message: `Releves temperatures du matin effectues`,
            timestamp: isoAt(d7, 6, 30 + Math.floor(Math.random() * 20)),
            user: operator.nom
        });

        if (Math.random() > 0.1) {
            entries.push({
                id: uid(), type: 'nettoyage',
                message: `Nettoyage zones cuisine valide`,
                timestamp: isoAt(d7, 7, Math.floor(Math.random() * 50)),
                user: pick(USERS).nom
            });
        }

        if (d7.getDay() >= 1 && d7.getDay() <= 4 && Math.random() > 0.4) {
            const fourn = pick(FOURNISSEURS);
            entries.push({
                id: uid(), type: 'reception',
                message: `Reception ${fourn.nom} ‚Äî controle effectue`,
                timestamp: isoAt(d7, 7 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 50)),
                user: operator.nom
            });
        }

        entries.push({
            id: uid(), type: 'ccp',
            message: `Controle CCP cuisson effectue`,
            timestamp: isoAt(d7, 11, Math.floor(Math.random() * 40)),
            user: operator.nom
        });

        entries.push({
            id: uid(), type: 'temperature',
            message: `Releves temperatures du midi effectues`,
            timestamp: isoAt(d7, 11, 30 + Math.floor(Math.random() * 25)),
            user: operator.nom
        });

        entries.push({
            id: uid(), type: 'nettoyage',
            message: `Nettoyage apres service valide`,
            timestamp: isoAt(d7, 14, Math.floor(Math.random() * 50)),
            user: pick(USERS).nom
        });

        entries.push({
            id: uid(), type: 'connexion',
            message: `Deconnexion de ${operator.nom}`,
            timestamp: isoAt(d7, 16 + Math.floor(Math.random() * 2), Math.floor(Math.random() * 50)),
            user: operator.nom
        });

        save('journal_' + ds, entries);
        journalCount += entries.length;
        d7.setDate(d7.getDate() + 1);
    }
    log(`  ${journalCount} entrees de journal`, 'ok');

    // MODULES COMPLEMENTAIRES - RESUME
    log('', '');
    log('[MODULES COMPLEMENTAIRES]', 'section');
    log(`  Separation cru/cuit: 1 plan`, 'ok');
    log(`  Recettes: ${recettes.length} recettes`, 'ok');
    log(`  RGPD: Registre initialise`, 'ok');
    log(`  AGEC (dons): ${agecDons.length} dons`, 'ok');
    log(`  Rappels produits: ${rappels.length} rappels`, 'ok');
    log(`  Archives DLC: ${archivesDLC.length} archives`, 'ok');
    log(`  Protocoles: 2 protocoles`, 'ok');

    // RESUME
    log('', '');
    log('=== INJECTION TERMINEE ===', 'section');
    log('', '');
    log(`Scenario "${scenario.nom}" injecte avec succes !`, 'ok');
    log(`Etablissement: ${scenario.etablissement}`, 'info');
    log(`Periode: ${scenario.jours} jours de donnees generees`, 'info');
    log(`Type: ${scenario.type} - ${scenario.effectif} personnes`, 'info');
    log('', '');
    log('TOUS LES MODULES ONT ETE REMPLIS:', 'info');
    log('  - Temperatures, CCP, Nettoyage, Receptions', 'info');
    log('  - Tracabilite, Menus, Inventaire, Fournisseurs', 'info');
    log('  - PAI, Formations, Alertes, Allergenes', 'info');
    log('  - Etiquettes, Huiles, Maintenance, Vestiaires', 'info');
    log('  - Gaspillage, Couverts, TIAC, Analyse risques', 'info');
    log('  - Separation cru/cuit, Recettes, RGPD, AGEC', 'info');
    log('  - Rappels produits, Archives DLC, Protocoles', 'info');
    log('', '');
    log('Ouvrez l\'application pour voir les donnees.', 'ok');
    log(`Connexion: Chef Martin / PIN: 1234 (admin)`, 'info');
    log(`Connexion: Sophie Durand / PIN: 5678`, 'info');
    log(`Connexion: Karim Benali / PIN: 9012`, 'info');
    log(`Connexion: Marie Lefebvre / PIN: 3456`, 'info');
}
</script>
</body>
</html>
