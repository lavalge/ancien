<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulateur Audit HACCP Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding: 20px; }
  h1 { color: #1a73e8; margin-bottom: 20px; }
  .card { margin-bottom: 15px; }
  .conforme { color: green; font-weight: bold; }
  .a-corriger { color: orange; font-weight: bold; }
  .non-conforme { color: red; font-weight: bold; }
  .section-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .score-bar { height: 20px; border-radius: 10px; }
</style>
</head>
<body>

<div class="container">
  <h1>Simulateur Audit HACCP</h1>
  <p>Simulez un audit complet et réaliste pour votre établissement.</p>
  
  <button class="btn btn-primary mb-3" onclick="runAudit()">Lancer Audit Complet</button>
  <button class="btn btn-success mb-3" onclick="exportPDF()">Exporter PDF</button>
  
  <div id="result"></div>
</div>

<script>
// ======================= QUESTIONS SIMULÉES =========================
const auditQuestions = [
  {section:"Documentation",question:"Registres de températures frigo du jour disponibles ?",weight:2},
  {section:"Documentation",question:"Plan HACCP à jour ?",weight:2},
  {section:"Documentation",question:"Procédures nettoyage affichées ?",weight:1},
  {section:"Documentation",question:"Registre nettoyage plan de travail complet ?",weight:2},
  {section:"Documentation",question:"Liste fournisseurs à jour ?",weight:1},

  {section:"Locaux",question:"Chambre froide propre ?",weight:2},
  {section:"Locaux",question:"Réfrigérateurs et congélateurs propres et organisés ?",weight:3},
  {section:"Locaux",question:"Séparation zones crues / cuites respectée ?",weight:3},
  {section:"Locaux",question:"Éclairage suffisant et fonctionnel ?",weight:1},
  {section:"Locaux",question:"Aération et ventilation correctes ?",weight:2},

  {section:"Hygiène",question:"Port des gants et charlotte correct ?",weight:2},
  {section:"Hygiène",question:"Lavages des mains conformes ?",weight:3},
  {section:"Hygiène",question:"Tenues propres ?",weight:2},
  {section:"Hygiène",question:"Formation hygiène du personnel affichée ?",weight:1},
  {section:"Hygiène",question:"Produits de nettoyage correctement étiquetés ?",weight:2},

  {section:"Cuisson",question:"Température cuisson respectée ?",weight:4},
  {section:"Cuisson",question:"Temps cuisson respecté ?",weight:3},
  {section:"Cuisson",question:"Plat témoin présent et conforme ?",weight:5},
  {section:"Cuisson",question:"Étiquetage préparations correct ?",weight:3},
  {section:"Cuisson",question:"Refroidissement rapide appliqué ?",weight:4},

  {section:"Stock",question:"Stock correctement étiqueté ?",weight:2},
  {section:"Stock",question:"Date de péremption respectée ?",weight:3},
  {section:"Stock",question:"Produits séparés (cru/cuit) ?",weight:2},
  {section:"Stock",question:"Produits allergènes identifiés ?",weight:2},
  {section:"Stock",question:"Produits conservés à la bonne température ?",weight:3},

  {section:"Matériel",question:"Ustensiles propres ?",weight:2},
  {section:"Matériel",question:"Balances et thermomètres calibrés ?",weight:3},
  {section:"Matériel",question:"Four et plaques propres ?",weight:2},
  {section:"Matériel",question:"Équipements en bon état ?",weight:1},
  {section:"Matériel",question:"Plans de travail propres ?",weight:2},

  {section:"Audit fictif",question:"Check listes d'hygiène complètes ?",weight:2},
  {section:"Audit fictif",question:"Signatures des responsables présentes ?",weight:1},
  {section:"Audit fictif",question:"Produits préparés selon procédures ?",weight:3},
  {section:"Audit fictif",question:"Élimination déchets respectée ?",weight:2},
  {section:"Audit fictif",question:"Contrôle températures jour précédent OK ?",weight:3},
  {section:"Audit fictif",question:"Étiquetage allergènes respecté ?",weight:3},
  {section:"Audit fictif",question:"Plans de nettoyage visibles et appliqués ?",weight:2},
  {section:"Audit fictif",question:"Rapports précédents archivés ?",weight:2},
  {section:"Audit fictif",question:"Formation continue suivie ?",weight:2},
  {section:"Audit fictif",question:"Procédures d'urgence affichées ?",weight:1},
  {section:"Audit fictif",question:"Plan de contrôle de réception produits appliqué ?",weight:3},
  {section:"Audit fictif",question:"Procédures PAI respectées ?",weight:2},
  {section:"Audit fictif",question:"Vérification eau chaude et froide OK ?",weight:2},
  {section:"Audit fictif",question:"Nettoyage sol et murs quotidien ?",weight:2},
  {section:"Audit fictif",question:"Contrôle insectes et rongeurs OK ?",weight:2},
];

// ======================= SIMULATION ALÉATOIRE =========================
function generateRandomResponses() {
  return auditQuestions.map(q=>{
    const rand = Math.random();
    if(rand<0.1) return "Non";
    if(rand<0.2) return "À corriger";
    return "Oui";
  });
}

// ======================= LANCER AUDIT =========================
function runAudit() {
  const responses = generateRandomResponses();
  let score = 0;
  const maxScore = auditQuestions.reduce((sum,q)=>sum+q.weight,0);
  
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  // Grouper par section
  const sections = [...new Set(auditQuestions.map(q=>q.section))];
  
  sections.forEach(section=>{
    const card = document.createElement("div");
    card.className = "card";

    const cardHeader = document.createElement("div");
    cardHeader.className = "card-header section-header";
    cardHeader.innerHTML = `<span>${section}</span><span>▼</span>`;
    card.appendChild(cardHeader);

    const cardBody = document.createElement("div");
    cardBody.className = "card-body";
    
    auditQuestions.forEach((q,i)=>{
      if(q.section===section){
        const resp = responses[i];
        let cls = resp==="Oui"?"conforme":resp==="À corriger"?"a-corriger":"non-conforme";
        if(resp==="Oui") score+=q.weight;
        const div = document.createElement("div");
        div.className = `question ${cls}`;
        div.innerHTML = `- ${q.question} : <strong>${resp}</strong>`;
        cardBody.appendChild(div);
      }
    });

    card.appendChild(cardBody);
    cardBody.style.display = "none"; // plié par défaut
    cardHeader.onclick = ()=> {
      cardBody.style.display = cardBody.style.display==="none"?"block":"none";
    };

    resultDiv.appendChild(card);
  });

  const percent = Math.round((score/maxScore)*100);

  const progressDiv = document.createElement("div");
  progressDiv.innerHTML = `<h4>Score global : ${percent}%</h4>
  <div class="progress">
    <div class="progress-bar ${percent>80?'bg-success':percent>50?'bg-warning':'bg-danger'}" role="progressbar" style="width: ${percent}%"></div>
  </div>`;
  resultDiv.appendChild(progressDiv);
}

// ======================= EXPORT PDF =========================
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const resultDiv = document.getElementById("result");
  doc.text(resultDiv.innerText, 10, 10);
  doc.save("Audit_HACCP_Pro.pdf");
}
</script>

</body>
</html>
